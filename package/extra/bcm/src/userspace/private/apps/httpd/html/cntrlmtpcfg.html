<html>
  <head>
    <meta charset='utf-8'>
    <title>Controller MTP Configuration</title>
    <link rel='stylesheet' href='tabletab.css' type='text/css'>
    <script src='jquery.js'></script>
    <script>
      var sessionKey='<%ejGetOther(sessionKey)%>';
      var uspAction='<%ejGet(uspAction)%>';
      var uspInfo='<%ejGet(uspInfo)%>';

      function cfgClick() {
        var val = '';
        var loc = 'cntrlmtpcfg.cgi?';
        var num = 0;

        // validate input
        if (document.getElementById('cntrlAlias').value == 'cpe-controller-0') {
          alert('Controller alias cannot be empty.');
          return;
        }
        // validate STOMP
        if (document.getElementById('protocol').value == 'STOMP') {
          if (document.getElementById('stompRef').value == 'cpe-stomp-0') {
            alert('STOMP reference cannot be empty.');
            return;
          }
        }
        // validate MQTT
        if (document.getElementById('protocol').value == 'MQTT') {
          if (document.getElementById('mqttReference').value == 'cpe-mqtt-client-0') {
            alert('MQTT reference cannot be empty.');
            return;
          }
        }
        // validate WebSocket
        if (document.getElementById('protocol').value == 'WebSocket') {
          if (document.getElementById('websocketHost').value == '') {
            alert('WebSocket host cannot be empty.');
            return;
          }
          if (document.getElementById('websocketPath').value == '') {
            alert('WebSocket path cannot be empty.');
            return;
          }
          num = parseInt(document.getElementById('websocketPort').value);
          if (num < 1 || num > 65535) {
            alert('WebSocket port ' + num + ' is out of range [1-65535].');
            return;
          }
          num = parseInt(document.getElementById('websocketAlive').value);
          if (num < 1) {
            alert('WebSocket keep alive interval ' + num + ' must be greater than 1');
            return;
          }
        }

        // Controller Alias and MTP Alias
        if (uspAction == 'edit') {
          if (uspInfo.length > 0) {
            var info = uspInfo.split('|');
            val += info[0] + '|' + info[1] +'|';
          } else
            val += '||';
        } else {
          // Controller Alias
          val +=  document.getElementById('cntrlAlias').value + '|';
          // MTP Alias
          val +=  '|';
        }

        // Enable MTP
        if (document.getElementById('enableMtp-1').checked)
          val += '1|';
        else
          val += '0|';

        // Protocol
        val += document.getElementById('protocol').value + '|';

        // STOMP Reference
        val += document.getElementById('stompRef').value + '|';
        // STOMP Destination
        val += document.getElementById('stompDst').value + '|';
        // MQTT Reference
        val += document.getElementById('mqttReference').value + '|';
        // MQTT Topic
        val += document.getElementById('mqttTopic').value + '|';
		// MQTT Publish Retain Response
        if (document.getElementById('response-1').checked)
          val += '1|';
        else
          val += '0|';
		// MQTT Publish Retain Notify
        if (document.getElementById('notify-1').checked)
          val += '1|';
        else
          val += '0|';
        // Websocket Host
        val += document.getElementById('websocketHost').value + '|';
        // Websocket Port
        val += document.getElementById('websocketPort').value + '|';
        // Websocket Path
        val += document.getElementById('websocketPath').value + '|';
        // Websocket EnableEncryption
        if (document.getElementById('wsenableEncrypt-1').checked)
          val += '1|';
        else
          val += '0|';
        // Websocket KeepAliveInterval
        val += document.getElementById('websocketAlive').value;

        if (uspAction == 'edit')
          loc += 'uspAction=apply&uspInfo=' + val;
        else
          loc += 'uspAction=new&uspInfo=' + val;

        loc += '&sessionKey=' + sessionKey;

        location.href = loc;
      }

      function changeProtocol(val) {
        var stomp = document.getElementById('stomp');
        var mqtt = document.getElementById('mqtt');
        var websocket = document.getElementById('websocket');

        if (val === 'STOMP') {
          stomp.style.display = 'block';
          mqtt.style.display = 'none';
          websocket.style.display = 'none';
        } else if (val === 'MQTT') {
          mqtt.style.display = 'block';
          stomp.style.display = 'none';
          websocket.style.display = 'none';
        } else if (val === 'WebSocket') {
          websocket.style.display = 'block';
          stomp.style.display = 'none';
          mqtt.style.display = 'none';
        }
      }

      function bodyLoad() {
        var cntrl = document.getElementById('cntrlAlias');
        var mtp = document.getElementById('mtpAlias');

        if (uspAction == 'edit') {
          // Controller Alias
          cntrl.disabled = true;
          // MTP Alias
          mtp.disabled = true;

          if (uspInfo.length > 0) {
            var info = uspInfo.split('|');

            // Controller Alias
            cntrl.value = info[0];
            // MTP Alias
            mtp.value = info[1];
            // Enable Connection
            if (info[2] == 'Yes')
              document.getElementById('enableMtp-1').checked = true;
            else
              document.getElementById('enableMtp-0').checked = true;
            // Protocol
            var proto = document.getElementById('protocol');

            // only handle STOPM, MQTT and WEBSOCKET protocol
            if (info[3] == 'STOMP') {
              // Protocol
              proto.value = 'STOMP';
              proto.onchange('STOMP');
            } else if (info[3] == 'MQTT') {
              // Protocol
              proto.value = 'MQTT';
              proto.onchange('MQTT');
            } else if (info[3] == 'WebSocket') {
              // Protocol
              proto.value = 'WebSocket';
              proto.onchange('WebSocket');
            }

            // STOMP Reference
            document.getElementById('stompRef').value = info[4];
            // STOMP Destination
            document.getElementById('stompDst').value = info[5];
            // MQTT Reference
            document.getElementById('mqttReference').value = info[6];
            // MQTT Topic
            document.getElementById('mqttTopic').value = info[7];
            // MQTT Publish Retain Response
            if (info[8] == 'Yes')
              document.getElementById('response-1').checked = true;
            else
              document.getElementById('response-0').checked = true;
            // MQTT Publish Retain Notify
            if (info[9] == 'Yes')
              document.getElementById('notify-1').checked = true;
            else
              document.getElementById('notify-0').checked = true;
            // WebSocket Host
            document.getElementById('websocketHost').value = info[10];
            // WebSocket Port
            document.getElementById('websocketPort').value = info[11];
            // WebSocket Path
            document.getElementById('websocketPath').value = info[12];
            // WebSocket EnableEncryption
            if (info[13] == 'Yes')
              document.getElementById('wsenableEncrypt-1').checked = true;
            else
              document.getElementById('wsenableEncrypt-0').checked = true;
            // Websocket KeepAliveInterval
            document.getElementById('websocketAlive').value = info[14];
          }

          // Edit button
          document.getElementById('btnCfg').value = 'Apply';
        } else {
          var proto = document.getElementById('protocol');

          // Controller Alias
          cntrl.disabled = false;
          // MTP Alias
          mtp.disabled = true;

          // Protocol
          proto.value = 'STOMP';
          proto.onchange('STOMP');

          // Enable Connection
          document.getElementById('enableMtp-1').checked = true;
          // MQTT Publish Retain Response
          document.getElementById('response-0').checked = true;
          // MQTT Publish Retain Notify
          document.getElementById('notify-0').checked = true;
          // WebSocket Enable Encryption
          document.getElementById('wsenableEncrypt-1').checked = true;
          // Add button
          document.getElementById('btnCfg').value = 'Add';
        }
      }
    </script>
  </head>
  <body onload='bodyLoad()'>
  <form>
    <center><h3>Controller MTP Configuration</h3><br>
    <div id='mtp'><center>
      <table id='tblMtpCfg' border='1' cellpadding='4' cellspacing='0'>
        <tbody>
          <tr>
            <td class='hd'>Controller Alias</td>
            <td colspan='2'>
				<select id='cntrlAlias'>
                  <option value='cpe-controller-0'></option>
<%ejGetOther(uspGetCntrlAliasList)%>
                </select>
            </td>
          </tr>
          <tr>
            <td class='hd'>MTP Alias</td>
            <td colspan='2'><input type='text' id='mtpAlias'></td>
          </tr>
          <tr height='25'>
          </tr>
          <tr>
            <td class='hd'>Enable MTP</td>
            <td><input name='enableMtp' id='enableMtp-0' type='radio'>  Disable</td>
            <td><input name='enableMtp' id='enableMtp-1' type='radio'>  Enable</td>
          </tr>
          <tr height='25'>
          </tr>
          <tr>
            <td class='hd'>Protocol</td>
            <td colspan='2'>
				<select id='protocol' onchange='changeProtocol(this.value)'>
                  <option value='STOMP' selected='selected'>STOMP</option>
                  <option value='MQTT'>MQTT</option>
                  <option value='WebSocket'>WebSocket</option>
                </select>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <br><br>
    <div id='stomp'><center>
      <table id='tblStompCfg' border='1' cellpadding='4' cellspacing='0'>
        <tbody>
          <tr>
            <td class='hd'>Destination</td>
            <td><input type='text' id='stompDst'></td>
          </tr>
          <tr>
            <td class='hd'>Reference</td>
            <td width='250'>
                <select id='stompRef' required>
                  <option value=''></option>
<%ejGetOther(uspGetStompConnFullPathList)%>
                </select>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id='mqtt'><center>
      <table id='tblMqttCfg' border='1' cellpadding='4' cellspacing='0'>
        <tbody>
          <tr>
            <td class='hd'>MQTT Reference</td>
            <td width='250' colspan='2'>
                <select id='mqttReference' required>
                  <option value=''></option>
<%ejGetOther(uspGetMqttClientFullPathList)%>
                </select>
            </td>
          </tr>
          <tr>
            <td class='hd'>MQTT Topic</td>
            <td colspan='2'><input type='text' id='mqttTopic'></td>
          </tr>
          <tr height='25' style="display:none;">
          </tr>
          <tr style="display:none;">
            <td class='hd'>Publish Retain Response</td>
            <td><input name='response' id='response-0' type='radio'>  Disable</td>
            <td><input name='response' id='response-1' type='radio'>  Enable</td>
          </tr>
          <tr style="display:none;">
            <td class='hd'>Publish Retain Notify</td>
            <td><input name='notify' id='notify-0' type='radio'>  Disable</td>
            <td><input name='notify' id='notify-1' type='radio'>  Enable</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id='websocket'><center>
      <table id='tblWebSocketCfg' border='1' cellpadding='4' cellspacing='0'>
        <tbody>
          <tr>
            <td class='hd'>Enable Encryption</td>
            <td><input name='wsenableEncrypt' id='wsenableEncrypt-0' type='radio'>  Disable</td>
            <td><input name='wsenableEncrypt' id='wsenableEncrypt-1' type='radio'>  Enable</td>
          </tr>
          <tr height='25'>
          </tr>
          <tr>
            <td class='hd'>Host</td>
            <td colspan='2'><input type='text' id='websocketHost'></td>
          </tr>
          <tr>
            <td class='hd'>Port</td>
            <td colspan='2'><input type='text' id='websocketPort'></td>
          </tr>
          <tr>
            <td class='hd'>Path</td>
            <td colspan='2'><input type='text' id='websocketPath'></td>
          </tr>
          <tr>
            <td class='hd'>KeepAliveInterval</td>
            <td colspan='2'><input type='text' id='websocketAlive'></td>
          </tr>
        </tbody>
      </table>
    </div>
    <br><br>
    <input type='button' id='btnCfg' onclick='cfgClick()'>
    <br><br>
  </form>
  </body>
</html>
