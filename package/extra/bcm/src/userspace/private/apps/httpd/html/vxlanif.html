<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
  <link rel="stylesheet" href="stylemain.css" type="text/css">
  <link rel="stylesheet" href="colors.css" type="text/css">
  <meta http-equiv="Pragma" content="no-cache">
  <title> VxLan Settings</title>

   <script language="javascript" src="util.js"></script>
   <script language="javascript">

<!-- hide

var vxlanTunnelId = '<%ejGet(vxlanTunnelId)%>';
var vxlanTunnelProto = '<%ejGet(vxlanTunnelProto)%>';

var vxlanTunnelIfLocalGwIf = '<%ejGet(vxlanTunnelIfLocalGwIf)%>';
var vxlanTunnelIfVNI = '<%ejGet(vxlanTunnelIfVNI)%>';
var vxlanTunnelIfIpAddress = '<%ejGet(vxlanTunnelIfIpAddress)%>';
var vxlanTunnelIfSubnet = '<%ejGet(vxlanTunnelIfSubnet)%>';
var enblIP6 = '<%ejGetOther(sysInfo, enblIPv6)%>';
var vxlanTunnelIfZeroCsumTx = '<%ejGet(vxlanTunnelIfZeroCsumTx)%>';
var vxlanTunnelIfZeroCsumRx = '<%ejGet(vxlanTunnelIfZeroCsumRx)%>';

function showhide(element, sh)
{
    var status;
    if (sh == 1) {
        status = "block";
    }
    else {
        status = "none"
    }

    if (document.getElementById)
    {
        // standard
        document.getElementById(element).style.display = status;
    }
    else if (document.all)
    {
        // old IE
        document.all[element].style.display = status;
    }
    else if (document.layers)
    {
        // Netscape 4
        document.layers[element].display = status;
    }
}

function setSelect(item, value)
{
    for (i=0; i<item.options.length; i++) {
        if (item.options[i].value == value) {
            item.selectedIndex = i;
            break;
        }
    }
}

function submitText(item, name)
{
    return '&' + name + '=' + item.value;
}

function getSelect(item)
{
    var idx;
    if (item.options.length > 0) {
        idx = item.selectedIndex;
        return item.options[idx].value;
    }
    else {
        return '';
    }
}

function submitSelect(item, name)
{
    return '&' + name + '=' + getSelect(item);
}

function formLoad()
{
    with ( document.forms[0] ) {
        tunnelIfVNI.value = vxlanTunnelIfVNI;
        tunnelIfIpAddress.value = '';
        tunnelIfSubnet.value = '';
        is_bridge.checked = true;
        tunnelIfZeroCsumTx.checked = true
        tunnelIfZeroCsumRx.checked = true

        if ( is_bridge.checked == true ) {
            showhide('ipaddr', 0);
            showhide('subnet', 0);
        }
        else {
            showhide('ipaddr', 1);
            showhide('subnet', 1);
        }

        if ( (vxlanTunnelProto == 'IPv6') && (enblIP6 == '1') ) {
            showhide('gwv4', 0);
            showhide('gwv6', 1);
            setSelect(localGwV6, 'None');
            showhide('CsumTx', 1);
            showhide('CsumRx', 1);
        }
        else {
            showhide('gwv4', 1);
            showhide('gwv6', 0);
            setSelect(localGwV4, 'None');
            showhide('CsumTx', 0);
            showhide('CsumRx', 0);
        }
    }
}

function bridgeClick(cb)
{
    with ( document.forms[0] ) {
        if ( cb.checked == true ) {
            showhide('ipaddr', 0);
            showhide('subnet', 0);
        }
        else {
            tunnelIfIpAddress.value = '';
            tunnelIfSubnet.value = '';
            showhide('ipaddr', 1);
            showhide('subnet', 1);
			
            if ( (vxlanTunnelProto == 'IPv6') && (enblIP6 == '1') ) {
                showhide('gwv4', 0);
                showhide('gwv6', 1);
                setSelect(localGwV4, 'None');
            }
            else {
                showhide('gwv4', 1);
                showhide('gwv6', 0);
                setSelect(localGwV6, 'None');
            }
        }
    }
}

function applyClick() {
    var loc = 'vxlan.cmd?action=addIf';
    with ( document.forms[0] ) {

        if ( is_bridge.checked == true ) {
            if ( (vxlanTunnelProto == 'IPv6') && (enblIP6 == '1') ) {
                if ( getSelect(localGwV6) == 'None' ) {
                    alert('Local Gateway Interface is invalid.');
                    return;
                }
            }
            else {
                if ( getSelect(localGwV4) == 'None' ) {
                    alert('Local Gateway Interface is invalid.');
                    return;
                }
            }
            loc += '&vxlanTunnelIsBridge=1';
        }
        else
        {
            if ((isValidIpAddress(tunnelIfIpAddress.value) == false) &&
                (isValidIpAddress6(tunnelIfIpAddress.value) == false)) {
                alert('IP Address "' + tunnelIfIpAddress.value + '" is invalid.');
                return;
            }
			
            if ( tunnelIfIpAddress.value.indexOf(':') > 0)
            {
                if (tunnelIfIpAddress.value.indexOf('/') == -1) {
                    //use default prefix length 64.
                    tunnelIfIpAddress.value = tunnelIfIpAddress.value + '/64';
                }
            }
            else { 
                if (isValidSubnetMask(tunnelIfSubnet.value) == false ) {
                    alert('Subnet "' + tunnelIfSubnet.value + '" is invalid.');
                    return;
                }
            }
				
            if ( (vxlanTunnelProto == 'IPv6') && (enblIP6 == '1') ) {
                if ( getSelect(localGwV6) == 'None' ) {
                    alert('Local Gateway Interface is invalid.');
                    return;
                }
            }
            else {
                if ( getSelect(localGwV4) == 'None' ) {
                    alert('Local Gateway Interface is invalid.');
                    return;
                }
            }
            loc += '&vxlanTunnelIsBridge=0';
        }

        loc += '&vxlanTunnelId=' + vxlanTunnelId;
        if ( tunnelIfIpAddress.value.indexOf(':') > 0)
        {
            loc += '&vxlanTunnelProto=' + 'IPv6';
        }
        else 
        {
            loc += '&vxlanTunnelProto=' + 'IPv4';
        }
		
        loc += submitText(tunnelIfVNI, 'vxlanTunnelIfVNI');
        loc += submitText(tunnelIfIpAddress, 'vxlanTunnelIfIpAddress');
        loc += submitText(tunnelIfSubnet, 'vxlanTunnelIfSubnet');

        if ( (vxlanTunnelProto == 'IPv6') && (enblIP6 == '1') )
            loc += submitSelect(localGwV6, 'vxlanTunnelIfLocalGwIf');
        else
            loc += submitSelect(localGwV4, 'vxlanTunnelIfLocalGwIf');

        if (tunnelIfZeroCsumTx.checked == true)
            loc += '&vxlanTunnelIfZeroCsumTx=1';
        else
            loc += '&vxlanTunnelIfZeroCsumTx=0';

        if (tunnelIfZeroCsumRx.checked == true)
            loc += '&vxlanTunnelIfZeroCsumRx=1';
        else
            loc += '&vxlanTunnelIfZeroCsumRx=0';

    }
    loc += '&sessionKey=<%ejGetOther(sessionKey)%>';
    var code = 'location="' + loc + '"';
    eval(code);
}

// done hiding -->
</script>

</head>

<body onLoad="formLoad()">
<blockquote>
<form>
  <b>VxLan Tunnel Interface Settings</b>
  <br><br>

  <tr>
     <td width='30' height="30"><input type='checkbox' name='is_bridge' onChange='bridgeClick(this)'></td>
     <td>L2 mode</td>
  </tr>

  <table border="0" cellpadding="0" cellspacing="2" width="100%">
    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
    <tr>
      <td width="40%"> VNI </td>
      <td> <input name="tunnelIfVNI" size="20" maxlength="60" type="text"> </td>
    </tr>
    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
  </table>

  <div id='ipaddr'>
  <table border="0" cellpadding="0" cellspacing="2" width="100%">
    <tr>
      <td width="40%"> IP address</td>
      <td> <input name="tunnelIfIpAddress" size="20" maxlength="60" type="text"> </td>
    </tr>
    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
  </table>
  </div>

  <div id='subnet'>
  <table border="0" cellpadding="0" cellspacing="2" width="100%">
    <tr>
      <td width="40%"> Subnet </td>
      <td> <input name="tunnelIfSubnet" size="20" maxlength="60" type="text"> </td>
    </tr>
    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
  </table>
  </div>

  <div id='gwv4'>
  <table border="0" cellpadding="0" cellspacing="2" width="100%">
    <tr><script language="javascript">
    <!-- hide
    {
      var i;
      var intfInfo = '<%ejGetOther(wanInterfaceInfo, route)%>';
      var intf     = intfInfo.split('|');

      document.writeln("<td width='40%'>Local Gateway Interface4:</td>");
      document.writeln("<td><select name='localGwV4'>");
      for ( i = 0; i < intf.length; i++ ) {
        var names = intf[i].split('/');
        if (names.length > 1) {
          document.write("  <option value='" + names[1] + "'>");
          document.writeln(intf[i]);
        }
      }
      document.write("  <option value='None'>");
      document.writeln("Select interface");
      document.writeln("    </select></td>");
    }
    // done hiding -->
    </script></tr>

    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
  </table>
  </div>

  <div id='gwv6'>
  <table border="0" cellpadding="0" cellspacing="2" width="100%">
    <tr><script language="javascript">
    <!-- hide
    {
      var i;
      var intfInfo = '<%ejGetOther(wanInterfaceInfo, route6)%>';
      var intf     = intfInfo.split('|');

      document.writeln("<td width='40%'>Local Gateway Interface6:</td>");
      document.writeln("<td><select name='localGwV6'>");
      for ( i = 0; i < intf.length; i++ ) {
        var names = intf[i].split('/');
        if (names.length > 1) {
          document.write("  <option value='" + names[1] + "'>");
          document.writeln(intf[i]);
        }
      }
      document.write("  <option value='None'>");
      document.writeln("Select interface");
      document.writeln("    </select></td>");
    }
    // done hiding -->
    </script>
    </tr>
    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
  </table>
  </div>

  <div id='CsumTx'>
  <table border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td width='30' height="30"><input type='checkbox' name='tunnelIfZeroCsumTx'></td>
      <td>Skip UDP checksum calculation for transmitted packets over IPv6.</td>
    </tr>
  </table>
  </div>
  <div id='CsumRx'>
  <table border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td width='30' height="30"><input type='checkbox' name='tunnelIfZeroCsumRx'></td>
      <td>Allow incoming UDP packets over IPv6 with zero checksum field </td>
    </tr>
  </table>
  </div>

  <table border="0" cellpadding="0" cellspacing="2" width="100%">
      <tr><td></td><td>&nbsp;</td></tr>
      <tr>
        <td colspan="2" align="center">
          <input value="Apply/Save" type="button" onclick="applyClick();" >
        </td>
      </tr>
  </table>
</form>
</blockquote>
</body>
</html>
