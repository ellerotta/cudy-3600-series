From ba3bfab17c4f3555580e18b2d0cb061b55c6cd0b Mon Sep 17 00:00:00 2001
From: Yongchan Kwon <yc.kwon@broadcom.com>
Date: Thu, 4 May 2023 14:38:51 +0900
Subject: [PATCH 2/2] Set ot-cli nodeID based on USB port number (BCM20708 does
 not return a unique IeeeEui64)

---
 src/posix/platform/settings.cpp | 15 +++++++++++++++
 src/posix/platform/system.cpp   | 15 +++++++++++++++
 2 files changed, 30 insertions(+)

diff --git a/src/posix/platform/settings.cpp b/src/posix/platform/settings.cpp
index f807ebc08..e51400bc3 100644
--- a/src/posix/platform/settings.cpp
+++ b/src/posix/platform/settings.cpp
@@ -62,6 +62,10 @@ static const size_t kMaxFileNameSize = sizeof(OPENTHREAD_CONFIG_POSIX_SETTINGS_P
 
 static int sSettingsFd = -1;
 
+#if (defined(BRCM_OPENTHREAD_ENABLE) && BRCM_OPENTHREAD_ENABLE)
+uint32_t gNodeId = 0xFFFFFFFF;
+#endif
+
 #if OPENTHREAD_POSIX_CONFIG_SECURE_SETTINGS_ENABLE
 static const uint16_t *sSensitiveKeys       = nullptr;
 static uint16_t        sSensitiveKeysLength = 0;
@@ -89,8 +93,19 @@ static void getSettingsFileName(otInstance *aInstance, char aFileName[kMaxFileNa
 
     otPlatRadioGetIeeeEui64(aInstance, reinterpret_cast<uint8_t *>(&nodeId));
     nodeId = ot::Encoding::BigEndian::HostSwap64(nodeId);
+#if (defined(BRCM_OPENTHREAD_ENABLE) && BRCM_OPENTHREAD_ENABLE)
+    /* BRCM_OPENTHREAD: Set ot-cli nodeID based on USB port number (BCM20708 does not return a unique IeeeEui64) */
+    if (gNodeId != 0xFFFFFFFF)
+    {
+        nodeId = gNodeId;
+    }
+    snprintf(aFileName, kMaxFileNameSize, OPENTHREAD_CONFIG_POSIX_SETTINGS_PATH "/%s_USB%" PRIx64 ".%s",
+             offset == nullptr ? "0" : offset, nodeId, (aSwap ? "swap" : "data"));
+#else
     snprintf(aFileName, kMaxFileNameSize, OPENTHREAD_CONFIG_POSIX_SETTINGS_PATH "/%s_%" PRIx64 ".%s",
              offset == nullptr ? "0" : offset, nodeId, (aSwap ? "swap" : "data"));
+
+#endif
 }
 
 static int swapOpen(otInstance *aInstance)
diff --git a/src/posix/platform/system.cpp b/src/posix/platform/system.cpp
index d74512efa..63314f30e 100644
--- a/src/posix/platform/system.cpp
+++ b/src/posix/platform/system.cpp
@@ -123,6 +123,21 @@ static const char *getTrelRadioUrl(otPlatformConfig *aPlatformConfig)
 
 void platformInit(otPlatformConfig *aPlatformConfig)
 {
+#if (defined(BRCM_OPENTHREAD_ENABLE) && BRCM_OPENTHREAD_ENABLE)
+/* BRCM_OPENTHREAD: Set ot-cli nodeID based on USB port number (BCM20708 does not return a unique IeeeEui64) */
+{
+    extern uint32_t gNodeId;
+    char *pRadioUrl;
+    if ((pRadioUrl = strstr((char *)aPlatformConfig->mRadioUrls[0], "USB")) != NULL)
+    {
+        /* pRadioUrl points to 'USB' in radio url */
+        gNodeId = pRadioUrl[3] - '0';       // Set gNodeId to USB port number
+    }
+    otPlatLog(OT_LOG_LEVEL_CRIT, OT_LOG_REGION_CORE, "mRadioUrls: %s", pRadioUrl);
+}
+#endif
+
+
 #if OPENTHREAD_POSIX_CONFIG_BACKTRACE_ENABLE
     platformBacktraceInit();
 #endif
-- 
2.25.1

